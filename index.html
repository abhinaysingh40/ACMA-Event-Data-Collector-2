<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Data Collector</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root { --uno-blue: #003366; --accent: #e31e24; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 550px; margin: auto; background: white; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); overflow: hidden; }
        
        .logo-container { text-align: center; padding: 15px 10px; background: white; }
        .logo-container img { max-width: 180px; height: auto; }

        .header { background: var(--uno-blue); color: white; padding: 15px; text-align: center; border-bottom: 3px solid var(--accent); }
        .header h2 { margin: 0; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; }
        
        .tabs { display: flex; background: #eee; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; }
        .tab-btn.active { background: white; color: var(--uno-blue); border-top: 4px solid var(--uno-blue); }
        
        .content { padding: 25px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 5px; color: #444; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        
        .employee-section { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px dashed var(--uno-blue); margin-bottom: 20px; }
        
        .btn-submit { width: 100%; padding: 16px; background: var(--uno-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .btn-submit:hover { background: #002244; }
        .btn-submit:disabled { background: #999; }

        #camera-area { width: 100%; background: #000; border-radius: 10px; overflow: hidden; aspect-ratio: 4/3; display: flex; align-items: center; margin-bottom: 15px; }
        video { width: 100%; }
        .hidden { display: none; }
        .hp-style { position: absolute; left: -5000px; top: -5000px; }
        
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-container">
        <img src="https://unomindakart.com/assets/front/img/uno-minda-logo.png" alt="Uno Minda Logo">
    </div>

    <div class="header"><h2>Event Data Collector</h2></div>
    
    <div class="tabs">
        <button class="tab-btn active" id="tab1" onclick="switchTab('manual')">Information</button>
        <button class="tab-btn" id="tab2" onclick="switchTab('scan')">Scan Card</button>
    </div>

    <div class="content">
        <div id="scan-ui" class="hidden">
            <div id="camera-area"><video id="video" autoplay playsinline></video></div>
            <button type="button" class="btn-submit" style="background:#444;" onclick="captureCard()">Extract Text from Card</button>
            <p id="ocr-status" style="text-align:center; font-size:12px; color:var(--uno-blue); margin-top:10px; font-weight:bold;"></p>
            <hr>
        </div>

        <form id="masterForm">
            <input type="hidden" name="auth_token" value="UnoMinda_ACMA_2026_Secure_Handshake">
            <div class="hp-style"><input type="text" name="hp_field" tabindex="-1" autocomplete="off"></div>

            <div class="employee-section">
                <div class="form-group" style="margin-bottom:0;">
                    <label>Data Filled By (Employee Name)*</label>
                    <input type="text" name="DataFilledBy" placeholder="Your Full Name" required>
                </div>
            </div>

            <div class="form-group">
                <label>Visitor Type*</label>
                <select name="VisitorType" id="vType" required onchange="handleTypeChange()">
                    <option value="">-- Select --</option>
                    <option value="Customer">Customer</option>
                    <option value="Supplier/ Service Provider">Supplier/ Service Provider</option>
                    <option value="Media">Media</option>
                </select>
            </div>
            
            <div id="subDiv" class="form-group hidden">
                <label>Category*</label>
                <select name="SubType" id="vSubType"></select>
            </div>

            <div style="display: flex; gap:10px;">
                <div class="form-group" style="flex:1;"><label>First Name*</label><input type="text" name="FirstName" id="fName" required></div>
                <div class="form-group" style="flex:1;"><label>Last Name*</label><input type="text" name="LastName" id="lName" required></div>
            </div>

            <div class="form-group"><label>Contact Number*</label><input type="tel" name="Contact" id="contact" required></div>
            <div class="form-group"><label>Email ID*</label><input type="email" name="Email" id="email" required></div>

            <div class="form-group">
                <label>State/UT*</label>
                <select name="State" id="state" required>
                    <option value="">-- Select --</option>
                    <optgroup label="States">
                        <option value="Andhra Pradesh">Andhra Pradesh</option>
                        <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                        <option value="Assam">Assam</option>
                        <option value="Bihar">Bihar</option>
                        <option value="Chhattisgarh">Chhattisgarh</option>
                        <option value="Goa">Goa</option>
                        <option value="Gujarat">Gujarat</option>
                        <option value="Haryana">Haryana</option>
                        <option value="Himachal Pradesh">Himachal Pradesh</option>
                        <option value="Jharkhand">Jharkhand</option>
                        <option value="Karnataka">Karnataka</option>
                        <option value="Kerala">Kerala</option>
                        <option value="Madhya Pradesh">Madhya Pradesh</option>
                        <option value="Maharashtra">Maharashtra</option>
                        <option value="Manipur">Manipur</option>
                        <option value="Meghalaya">Meghalaya</option>
                        <option value="Mizoram">Mizoram</option>
                        <option value="Nagaland">Nagaland</option>
                        <option value="Odisha">Odisha</option>
                        <option value="Punjab">Punjab</option>
                        <option value="Rajasthan">Rajasthan</option>
                        <option value="Sikkim">Sikkim</option>
                        <option value="Tamil Nadu">Tamil Nadu</option>
                        <option value="Telangana">Telangana</option>
                        <option value="Tripura">Tripura</option>
                        <option value="Uttar Pradesh">Uttar Pradesh</option>
                        <option value="Uttarakhand">Uttarakhand</option>
                        <option value="West Bengal">West Bengal</option>
                    </optgroup>
                    <optgroup label="Union Territories">
                        <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                        <option value="Chandigarh">Chandigarh</option>
                        <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                        <option value="Delhi">Delhi</option>
                        <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                        <option value="Ladakh">Ladakh</option>
                        <option value="Lakshadweep">Lakshadweep</option>
                        <option value="Puducherry">Puducherry</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="form-group"><label>City*</label><input type="text" name="City" id="city" required></div>

            <div class="form-group">
                <label>Country*</label>
                <select id="countrySelector" onchange="toggleCountryInput()" required>
                    <option value="India" selected>India</option>
                    <option value="Other">Other Country</option>
                </select>
            </div>

            <div id="otherCountryDiv" class="form-group hidden">
                <label>Specify Country Name*</label>
                <input type="text" id="otherCountryInput" placeholder="Enter country name">
            </div>
            <input type="hidden" name="Country" id="finalCountry" value="India">

            <div class="form-group"><label>Business Details/Remarks</label><textarea name="BusinessDetails" id="biz" rows="2"></textarea></div>

            <div class="form-group">
                <label>Connected with Uno Minda?</label>
                <select name="UnoMinda" id="uno"><option value="No">No</option><option value="Yes">Yes</option></select>
            </div>

            <input type="hidden" name="RawScannedText" id="rawText">
            <button type="submit" class="btn-submit" id="submitBtn">Submit Data</button>
        </form>
    </div>
</div>

<canvas id="canvas" class="hidden"></canvas>

<script>
    // REPLACE WITH YOUR APPS SCRIPT URL
    const G_URL = 'https://script.google.com/macros/s/AKfycbx4it3toakTzgFXKO7yDqmqRw1jBWWn9IrvwiXS0xKrwM0-kvRaqU2HT7TBUiw2BNbz7w/exec'; 
    const video = document.getElementById('video');

    function switchTab(mode) {
        document.getElementById('tab1').classList.toggle('active', mode === 'manual');
        document.getElementById('tab2').classList.toggle('active', mode === 'scan');
        document.getElementById('scan-ui').classList.toggle('hidden', mode === 'manual');
        if(mode === 'scan') startCamera(); else stopCamera();
    }

    async function startCamera() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = s;
        } catch (e) { alert("Camera access denied. Ensure HTTPS is used."); }
    }

    function stopCamera() {
        if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
    }

    function handleTypeChange() {
        const t = document.getElementById('vType').value;
        const sub = document.getElementById('vSubType');
        const subDiv = document.getElementById('subDiv');
        
        if (!t) {
            subDiv.classList.add('hidden');
            return;
        }
        
        subDiv.classList.remove('hidden');
        sub.innerHTML = "";
        let o = t === "Customer" ? ["OEM", "EV Manufacturer", "Distributor", "Retailer", "Workshop", "Mechanic"] : 
                (t === "Media" ? ["English", "Hindi", "Regional"] : ["Product Supplier", "Tech Solutions", "Service Provider"]);
        o.forEach(opt => sub.innerHTML += `<option value="${opt}">${opt}</option>`);
    }

    // Logic for Other Country
    function toggleCountryInput() {
        const selector = document.getElementById('countrySelector');
        const otherDiv = document.getElementById('otherCountryDiv');
        const otherInput = document.getElementById('otherCountryInput');
        const finalCountry = document.getElementById('finalCountry');

        if (selector.value === "Other") {
            otherDiv.classList.remove('hidden');
            otherInput.required = true;
            finalCountry.value = otherInput.value;
        } else {
            otherDiv.classList.add('hidden');
            otherInput.required = false;
            finalCountry.value = "India";
        }
    }

    // Listen for manual typing in the Other Country box
    document.getElementById('otherCountryInput').addEventListener('input', function() {
        document.getElementById('finalCountry').value = this.value;
    });

    async function captureCard() {
        const c = document.getElementById('canvas');
        const ctx = c.getContext('2d');
        if (video.videoWidth === 0) return;
        
        c.width = video.videoWidth; c.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        document.getElementById('ocr-status').innerText = "AI Analyzing Card... Please Wait";
        
        try {
            const { data: { text } } = await Tesseract.recognize(c.toDataURL('image/jpeg'), 'eng');
            document.getElementById('rawText').value = text;
            
            const email = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
            const phone = text.match(/[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,8}/);
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 3);

            if(email) document.getElementById('email').value = email[0];
            if(phone) document.getElementById('contact').value = phone[0];
            for(let l of lines) {
                if(/^[A-Z][a-z]+\s[A-Z][a-z]+/.test(l)) {
                    let p = l.split(' ');
                    document.getElementById('fName').value = p[0];
                    document.getElementById('lName').value = p[1] || "";
                    break;
                }
            }
            document.getElementById('ocr-status').innerText = "Extraction Complete!";
            setTimeout(() => switchTab('manual'), 1200);
        } catch (err) {
            document.getElementById('ocr-status').innerText = "OCR Failed. Please fill manually.";
        }
    }

    document.getElementById('masterForm').onsubmit = function(e) {
        e.preventDefault();
        
        // Ensure final country is set before sending
        const selector = document.getElementById('countrySelector');
        const finalCountry = document.getElementById('finalCountry');
        if (selector.value === "India") finalCountry.value = "India";

        const btn = document.getElementById('submitBtn');
        btn.disabled = true; 
        btn.innerText = "Saving to Sheets...";
        
        fetch(G_URL, { method: 'POST', body: new FormData(this) })
        .then(r => r.text())
        .then(txt => {
            if(txt === "Success") { 
                alert("Data Saved Successfully!"); 
                location.reload(); 
            } else { 
                alert("Server Response: " + txt); 
                btn.disabled = false; 
                btn.innerText = "Submit Data";
            }
        }).catch(() => { 
            alert("Network Error: Please check your internet."); 
            btn.disabled = false; 
            btn.innerText = "Submit Data";
        });
    };
</script>
</body>
</html>
